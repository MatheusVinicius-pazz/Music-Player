<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reprodutor de Música - VinilPlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.8)), url('https://res.cloudinary.com/dnrrgpoxt/image/upload/v1763463280/Gemini_Generated_Image_hutje5hutje5hutj_fwwtih.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            color: #e0e0e0;
        }
        .container { max-width: 1200px; }
        .card {
            background-color: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }
        
        /* --- INPUTS --- */
        .search-input, .modal-input {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
            padding: 0.5rem 1rem;
            color: white;
            width: 100%;
            outline: none;
            transition: all 0.3s ease;
        }
        .search-input:focus, .modal-input:focus {
            background-color: rgba(0, 0, 0, 0.5);
            border-color: #1db954;
            box-shadow: 0 0 10px rgba(29, 185, 84, 0.3);
        }
        .search-input::placeholder { color: #aaa; }

        /* --- MODAIS --- */
        #modal-overlay, #loading-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #modal-overlay.show, #loading-overlay.show { display: flex; opacity: 1; }
        
        .modal-box {
            background-color: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            text-align: center;
            position: relative;
        }
        #modal-overlay.show .modal-box { transform: scale(1); }
        
        .modal-btn {
            padding: 0.5rem 1.5rem;
            border-radius: 2rem;
            font-weight: bold;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            margin: 0 0.5rem;
        }
        .btn-cancel {
            background-color: transparent;
            border: 1px solid #555;
            color: #ccc;
        }
        .btn-cancel:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .btn-confirm-green { background-color: #1db954; color: black; }
        .btn-confirm-green:hover { background-color: #1ed760; transform: scale(1.05); }
        .btn-confirm-red { background-color: #ff4d4f; color: white; }
        .btn-confirm-red:hover { background-color: #ff7875; transform: scale(1.05); }

        /* Spinner */
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top-color: #1db954;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem auto;
            box-shadow: 0 0 15px rgba(29, 185, 84, 0.2);
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- GRID E LISTA --- */
        .folder-grid-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            text-align: center;
            border: 1px solid transparent;
        }
        .folder-grid-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .folder-icon-large {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 0.75rem;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        
        .folder-menu-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #aaa;
            padding: 6px 10px;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
            z-index: 10;
            background-color: rgba(0,0,0,0.5);
        }
        .folder-grid-item:hover .folder-menu-btn, .folder-menu-btn.active { opacity: 1; }
        .folder-menu-btn:hover { background-color: #1db954; color: black; }

        .context-menu {
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: #222;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.7);
            width: 160px;
            z-index: 50;
            display: none;
            overflow: hidden;
            flex-direction: column;
        }
        .context-menu.show { display: flex; }
        .context-menu-item {
            padding: 0.75rem 1rem;
            text-align: left;
            color: #e0e0e0;
            font-size: 0.9rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
        }
        .context-menu-item:hover { background-color: #333; color: #1db954; }
        .context-menu-item.delete:hover { color: #ff4d4f; background-color: rgba(255, 77, 79, 0.1); }
        
        .song-list-item {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .song-list-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .song-list-item.active {
            background-color: rgba(29, 185, 84, 0.2);
            border-left: 4px solid #1db954;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #a0a0a0;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        #audio-controls button.main-play-btn {
            font-size: 3.5rem;
            color: #1db954;
            filter: drop-shadow(0 0 10px rgba(29, 185, 84, 0.5));
        }
        
        /* BARRA DE PROGRESSO CORRIGIDA */
        #progress-bar-container {
            height: 6px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        #progress-bar {
            height: 100%;
            background-color: #1db954;
            width: 0%;
            transition: width 0.1s linear;
            box-shadow: 0 0 10px rgba(29, 185, 84, 0.7);
            border-radius: 3px;
        }
        
        .delete-btn { color: #ff4d4f; opacity: 0.5; transition: all 0.2s; }
        .delete-btn:hover { color: #ff0000; transform: scale(1.2); opacity: 1; }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center min-h-screen">
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('file-upload');
            const libraryContainer = document.getElementById('library-container');
            const audioPlayer = document.getElementById('audio-player');
            const currentSongTitle = document.getElementById('current-song-title');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const totalTimeEl = document.getElementById('total-time');
            const searchInput = document.getElementById('search-input');
            
            // Elementos dos Modais
            const modalOverlay = document.getElementById('modal-overlay');
            const loadingOverlay = document.getElementById('loading-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalInputContainer = document.getElementById('modal-input-container');
            const modalInput = document.getElementById('modal-input');
            const btnCancel = document.getElementById('btn-cancel');
            const btnConfirm = document.getElementById('btn-confirm');
            
            const folderIconUrl = "https://res.cloudinary.com/dnrrgpoxt/image/upload/v1763466883/Gemini_Generated_Image_tvtbx4tvtbx4tvtb-removebg-preview_vzpqjy.png"; 
            
            const mimeTypes = { 'mp3': 'audio/mpeg', 'wav': 'audio/wav', 'ogg': 'audio/ogg', 'm4a': 'audio/mp4', 'flac': 'audio/flac' };

            let playlist = JSON.parse(localStorage.getItem('playlist')) || [];
            let currentSongIndex = -1;
            let isPlaying = false;
            let currentView = 'root'; 
            let openFolder = null; 
            let searchQuery = '';
            
            // Correção: Inicializar com 0 para evitar NaN na UI
            progressBar.style.width = '0%';
            currentTimeEl.textContent = "0:00";
            totalTimeEl.textContent = "0:00";

            function savePlaylist() {
                localStorage.setItem('playlist', JSON.stringify(playlist));
            }
            
            // --- LÓGICA DE MODAIS (CORRIGIDA) ---
            function showLoading() {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.offsetHeight; 
                loadingOverlay.classList.add('show');
            }
            
            function hideLoading() {
                loadingOverlay.classList.remove('show');
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 300);
            }

            function showConfirmModal(title, message, confirmText = 'Confirmar', isDanger = false, showCancel = true) {
                return new Promise((resolve) => {
                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    modalMessage.classList.remove('hidden');
                    modalInputContainer.classList.add('hidden');
                    
                    btnConfirm.textContent = confirmText;
                    btnConfirm.className = 'modal-btn ' + (isDanger ? 'btn-confirm-red' : 'btn-confirm-green');
                    btnCancel.style.display = showCancel ? 'inline-block' : 'none';

                    // Remove listeners antigos sobrescrevendo o onclick
                    btnConfirm.onclick = () => {
                        closeModal();
                        resolve(true);
                    };
                    
                    btnCancel.onclick = () => {
                        closeModal();
                        resolve(false);
                    };

                    modalOverlay.style.display = 'flex';
                    modalOverlay.offsetHeight; 
                    modalOverlay.classList.add('show');
                });
            }

            function showPromptModal(title, initialValue = '') {
                return new Promise((resolve) => {
                    modalTitle.textContent = title;
                    modalMessage.classList.add('hidden');
                    modalInputContainer.classList.remove('hidden');
                    modalInput.value = initialValue;
                    
                    btnConfirm.textContent = 'Salvar';
                    btnConfirm.className = 'modal-btn btn-confirm-green';
                    btnCancel.style.display = 'inline-block';
                    
                    const handleConfirm = () => {
                        const val = modalInput.value;
                        closeModal();
                        resolve(val);
                    };

                    btnConfirm.onclick = handleConfirm;
                    
                    modalInput.onkeydown = (e) => { if(e.key === 'Enter') handleConfirm(); };
                    
                    btnCancel.onclick = () => {
                        closeModal();
                        resolve(null);
                    };

                    modalOverlay.style.display = 'flex';
                    modalOverlay.offsetHeight; 
                    modalOverlay.classList.add('show');
                    setTimeout(() => modalInput.focus(), 100);
                });
            }

            function closeModal() {
                modalOverlay.classList.remove('show');
                setTimeout(() => { modalOverlay.style.display = 'none'; }, 300);
            }

            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderLibrary();
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.folder-menu-btn') && !e.target.closest('.context-menu')) {
                    document.querySelectorAll('.context-menu').forEach(menu => menu.classList.remove('show'));
                    document.querySelectorAll('.folder-menu-btn').forEach(btn => btn.classList.remove('active'));
                }
            });

            // --- UPLOAD AUTOMÁTICO ---
            fileInput.addEventListener('change', (event) => {
                const files = event.target.files;
                if (files.length > 0) { processFiles(files); }
            });

            async function processFiles(files) {
                showLoading();
                await new Promise(r => setTimeout(r, 300)); 

                const newSongs = [];
                let detectedFolderName = "Geral";

                for (const file of files) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    // Lógica de detecção de pasta
                    if (file.webkitRelativePath) {
                        const parts = file.webkitRelativePath.split('/');
                        if (parts.length > 1) {
                            detectedFolderName = parts[0]; 
                        }
                    } else if (currentView === 'folder' && openFolder) {
                        detectedFolderName = openFolder;
                    }

                    if (mimeTypes[extension] && file.size > 0) {
                        const url = URL.createObjectURL(file);
                        newSongs.push({ 
                            name: file.name, 
                            url: url, 
                            path: file.webkitRelativePath || file.name, 
                            folder: detectedFolderName 
                        });
                    }
                }

                if (newSongs.length > 0) {
                    playlist = [...playlist, ...newSongs];
                    savePlaylist();
                    renderLibrary();
                    hideLoading();
                    await showConfirmModal("Sucesso!", `${newSongs.length} arquivos importados para a pasta "${detectedFolderName}".`, "OK", false, false);
                } else {
                    hideLoading();
                    await showConfirmModal("Erro", "Nenhum arquivo de áudio válido encontrado.", "Fechar", true, false);
                }
                fileInput.value = ''; 
            }

            // --- RENDERIZAÇÃO ---
            function renderLibrary() {
                libraryContainer.innerHTML = '';
                
                if (playlist.length === 0) {
                    libraryContainer.innerHTML = `<li class="p-8 rounded-lg text-gray-400 text-center border-2 border-dashed border-gray-600 flex flex-col items-center justify-center h-full bg-black/30">
                        <i class="fas fa-cloud-upload-alt text-4xl mb-3 opacity-50"></i>
                        <p>Sua biblioteca está vazia.</p>
                        <p class="text-sm mt-1 text-gray-500">Importe uma pasta para começar.</p>
                    </li>`;
                    return;
                }

                if (searchQuery.length > 0) {
                    renderSearchResults();
                    return;
                }

                const groupedByFolder = {};
                playlist.forEach(song => {
                    if (!groupedByFolder[song.folder]) { groupedByFolder[song.folder] = []; }
                    groupedByFolder[song.folder].push(song);
                });

                if (currentView === 'root') {
                    renderFolderGrid(groupedByFolder);
                } else if (currentView === 'folder' && openFolder) {
                    renderFolderContents(openFolder, groupedByFolder[openFolder]);
                }
            }

            function renderFolderGrid(groupedByFolder) {
                const breadcrumb = document.createElement('div');
                breadcrumb.className = 'breadcrumb';
                breadcrumb.innerHTML = `<i class="fas fa-home"></i> <span>Início</span>`;
                libraryContainer.appendChild(breadcrumb);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-2';

                Object.keys(groupedByFolder).sort().forEach(folderName => {
                    const count = groupedByFolder[folderName].length;
                    const folderItem = document.createElement('div');
                    folderItem.className = 'folder-grid-item group';
                    
                    folderItem.innerHTML = `
                        <button class="folder-menu-btn" title="Opções"><i class="fas fa-ellipsis-v"></i></button>
                        <div class="context-menu">
                            <div class="context-menu-item action-play"><i class="fas fa-play text-green-400"></i> Tocar Pasta</div>
                            <div class="context-menu-item action-rename"><i class="fas fa-pen text-blue-400"></i> Renomear</div>
                            <div class="context-menu-item action-delete delete"><i class="fas fa-trash text-red-400"></i> Excluir</div>
                        </div>
                        <img src="${folderIconUrl}" alt="Pasta" class="folder-icon-large group-hover:scale-110 transition-transform">
                        <span class="text-white font-semibold text-sm truncate w-full" title="${folderName}">${folderName}</span>
                        <span class="text-xs text-gray-400">${count} músicas</span>
                    `;

                    folderItem.addEventListener('click', (e) => {
                        if (!e.target.closest('.folder-menu-btn') && !e.target.closest('.context-menu')) {
                            currentView = 'folder';
                            openFolder = folderName;
                            renderLibrary();
                        }
                    });

                    const menuBtn = folderItem.querySelector('.folder-menu-btn');
                    const menu = folderItem.querySelector('.context-menu');

                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.context-menu').forEach(m => m !== menu ? m.classList.remove('show') : null);
                        menu.classList.toggle('show');
                        menuBtn.classList.toggle('active');
                    });

                    folderItem.querySelector('.action-play').addEventListener('click', (e) => {
                        e.stopPropagation();
                        playFolder(folderName);
                        menu.classList.remove('show');
                    });

                    folderItem.querySelector('.action-rename').addEventListener('click', (e) => {
                        e.stopPropagation();
                        menu.classList.remove('show');
                        renameFolder(folderName);
                    });

                    folderItem.querySelector('.action-delete').addEventListener('click', (e) => {
                        e.stopPropagation();
                        menu.classList.remove('show');
                        deleteFolder(folderName);
                    });

                    grid.appendChild(folderItem);
                });
                libraryContainer.appendChild(grid);
            }

            function playFolder(folderName) {
                const firstSongIndex = playlist.findIndex(s => s.folder === folderName);
                if (firstSongIndex !== -1) {
                    currentView = 'folder';
                    openFolder = folderName;
                    renderLibrary();
                    playSong(firstSongIndex);
                }
            }

            async function deleteFolder(folderName) {
                const confirmed = await showConfirmModal(
                    "Excluir Pasta", 
                    `Apagar a pasta "${folderName}" e todas as suas músicas?`,
                    "Excluir", true
                );
                if(confirmed) {
                    playlist = playlist.filter(song => song.folder !== folderName);
                    savePlaylist();
                    renderLibrary();
                    
                    // Reseta se a música atual for apagada
                    if (currentSongTitle.textContent !== 'Nenhuma música selecionada') {
                        // Se a música que está tocando pertencia a pasta apagada, reseta
                        // Mas como currentSongIndex é global, ele pode apontar para outra coisa agora.
                        // Solução segura: Parar tudo para evitar erros.
                         resetPlayerUI(); 
                         audioPlayer.pause();
                    }
                    await showConfirmModal("Sucesso", "Pasta removida.", "OK", false, false);
                }
            }

            async function renameFolder(oldName) {
                const newName = await showPromptModal("Renomear Pasta", oldName);
                if (newName && newName.trim() !== "" && newName !== oldName) {
                    playlist.forEach(song => {
                        if (song.folder === oldName) song.folder = newName;
                    });
                    savePlaylist();
                    renderLibrary();
                }
            }

            function renderSearchResults() {
                const breadcrumb = document.createElement('div');
                breadcrumb.className = 'breadcrumb';
                breadcrumb.innerHTML = `<i class="fas fa-search"></i> <span>Resultados para "${searchInput.value}"</span>`;
                libraryContainer.appendChild(breadcrumb);

                const listContainer = document.createElement('ul');
                listContainer.className = 'space-y-1';

                const results = playlist.filter(song => 
                    song.name.toLowerCase().includes(searchQuery) || 
                    song.folder.toLowerCase().includes(searchQuery)
                );

                if (results.length === 0) {
                     libraryContainer.innerHTML += `<div class="text-center text-gray-500 mt-10">Nenhum resultado encontrado.</div>`;
                     return;
                }

                results.forEach(song => {
                    const originalIndex = playlist.indexOf(song); 
                    createSongElement(song, originalIndex, listContainer, true);
                });
                libraryContainer.appendChild(listContainer);
            }

            function renderFolderContents(folderName, songs) {
                const breadcrumb = document.createElement('div');
                breadcrumb.className = 'breadcrumb';
                
                const backBtn = document.createElement('button');
                backBtn.innerHTML = `<i class="fas fa-arrow-left mr-1"></i> Voltar`;
                backBtn.onclick = () => {
                    currentView = 'root';
                    openFolder = null;
                    renderLibrary();
                };

                const separator = document.createElement('span');
                separator.innerHTML = `<i class="fas fa-chevron-right text-xs mx-2"></i>`;
                const currentFolderLabel = document.createElement('span');
                currentFolderLabel.className = 'text-white font-medium truncate';
                currentFolderLabel.textContent = folderName;

                breadcrumb.appendChild(backBtn);
                breadcrumb.appendChild(separator);
                breadcrumb.appendChild(currentFolderLabel);
                libraryContainer.appendChild(breadcrumb);

                const listContainer = document.createElement('ul');
                listContainer.className = 'space-y-1';

                songs.forEach(song => {
                    const originalIndex = playlist.findIndex(s => s.path === song.path);
                    createSongElement(song, originalIndex, listContainer, false);
                });
                libraryContainer.appendChild(listContainer);
            }

            function createSongElement(song, index, container, showFolderInfo) {
                const listItem = document.createElement('li');
                listItem.className = 'song-list-item';
                if (index === currentSongIndex) listItem.classList.add('active');
                
                const folderInfo = showFolderInfo ? `<span class="text-[10px] text-gray-500 ml-5 truncate"><i class="fas fa-folder-open mr-1"></i>${song.folder}</span>` : '';
                
                listItem.innerHTML = `
                    <div class="flex flex-col overflow-hidden flex-1">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-music text-gray-500 text-xs"></i>
                            <span class="text-gray-200 text-sm font-medium truncate">${song.name}</span>
                        </div>
                        ${folderInfo}
                    </div>
                    <div class="flex items-center gap-3 ml-2">
                        <button class="delete-btn" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                listItem.addEventListener('click', (event) => {
                    if (!event.target.closest('.delete-btn')) playSong(index); 
                });
                
                // Correção do evento de deletar música
                listItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSong(index);
                });

                container.appendChild(listItem);
            }

            async function deleteSong(index) {
                // Corrigido validação de índice
                if (index < 0 || index >= playlist.length) return;
                
                const confirmed = await showConfirmModal("Excluir Música?", "Remover este arquivo da biblioteca?", "Excluir", true);
                if (confirmed) {
                    const urlToDelete = playlist[index].url;
                    playlist.splice(index, 1);
                    savePlaylist();
                    
                    // Se a pasta ficar vazia, volta pro root
                    if (currentView === 'folder' && openFolder) {
                        if (playlist.filter(s => s.folder === openFolder).length === 0) {
                            currentView = 'root'; openFolder = null;
                        }
                    }
                    renderLibrary();
                    
                    if (urlToDelete.startsWith('blob:')) URL.revokeObjectURL(urlToDelete);
                    
                    // Reseta player se necessário
                    if (index === currentSongIndex) { resetPlayerUI(); audioPlayer.pause(); } 
                    else if (index < currentSongIndex) currentSongIndex--;
                }
            }
            
            function resetPlayerUI() {
                currentSongIndex = -1;
                isPlaying = false;
                audioPlayer.src = '';
                currentSongTitle.textContent = 'Nenhuma música selecionada';
                playPauseBtn.innerHTML = '<i class="fas fa-circle-play"></i>';
                progressBar.style.width = '0%';
                currentTimeEl.textContent = "0:00";
                totalTimeEl.textContent = "0:00";
            }

            function playSong(index) {
                if (index < 0 || index >= playlist.length) return;
                audioPlayer.pause();
                currentSongIndex = index;
                const song = playlist[currentSongIndex];
                audioPlayer.src = song.url;
                audioPlayer.play().catch(error => console.error(error));
                isPlaying = true;
                currentSongTitle.textContent = song.name;
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                renderLibrary();
            }

            function togglePlayPause() {
                if (playlist.length === 0) { showConfirmModal("Info", "Carregue músicas primeiro.", "OK", false, false); return; }
                if (!audioPlayer.src) { playSong(0); return; }
                if (audioPlayer.paused) {
                    audioPlayer.play(); isPlaying = true; playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    audioPlayer.pause(); isPlaying = false; playPauseBtn.innerHTML = '<i class="fas fa-circle-play"></i>';
                }
            }

            function playNext() { if (playlist.length === 0) return; playSong((currentSongIndex + 1) % playlist.length); }
            function playPrev() { if (playlist.length === 0) return; playSong((currentSongIndex - 1 + playlist.length) % playlist.length); }
            function formatTime(s) { return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`; }

            playPauseBtn.addEventListener('click', togglePlayPause);
            nextBtn.addEventListener('click', playNext);
            prevBtn.addEventListener('click', playPrev);
            audioPlayer.addEventListener('ended', playNext);
            
            // Lógica da barra de progresso
            audioPlayer.addEventListener('timeupdate', () => {
                if (!isNaN(audioPlayer.duration)) {
                    const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    progressBar.style.width = `${percent}%`;
                    currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                }
            });
            audioPlayer.addEventListener('loadedmetadata', () => {
                if (!isNaN(audioPlayer.duration)) totalTimeEl.textContent = formatTime(audioPlayer.duration);
            });
            progressBarContainer.addEventListener('click', (e) => {
                if (!isNaN(audioPlayer.duration)) {
                    // Ajuste para pegar largura correta
                    const rect = progressBarContainer.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const width = rect.width;
                    audioPlayer.currentTime = (clickX / width) * audioPlayer.duration;
                }
            });

            renderLibrary();
        });
    </script>

    <header class="text-center mb-8 w-full relative z-10">
        <img src="https://res.cloudinary.com/dnrrgpoxt/image/upload/v1763465227/Gemini_Generated_Image_vx3v7rvx3v7rvx3v__1_-removebg-preview_xkkobr.png" alt="Logo VinilPlay" class="h-48 md:h-64 mx-auto mb-4 drop-shadow-2xl hover:scale-105 transition-transform duration-300" />
        <p class="text-gray-200 mt-2 drop-shadow-md font-medium text-xl tracking-wide">Sua coleção, seu ritmo.</p>
    </header>

    <main class="w-full container grid grid-cols-1 lg:grid-cols-3 gap-8 relative z-10">
        <section class="card lg:col-span-1 flex flex-col items-center h-fit sticky top-4">
            <div class="w-full flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Player</h2>
                <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
            </div>
            <div class="w-full aspect-square rounded-xl bg-black/40 border border-white/10 mb-6 flex items-center justify-center shadow-inner relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-tr from-green-900/20 to-transparent"></div>
                <i class="fas fa-music text-7xl text-green-500/30 group-hover:scale-110 transition-transform duration-500"></i>
            </div>
            <div class="w-full mb-6">
                <p id="current-song-title" class="text-lg font-bold text-white truncate w-full text-center mb-1">Nenhuma música selecionada</p>
                <p class="text-xs text-green-400 text-center font-mono">PRONTO PARA TOCAR</p>
            </div>
            <div class="w-full my-2">
                <div id="progress-bar-container" class="mb-2"><div id="progress-bar"></div></div>
                <div class="flex justify-between text-xs text-gray-400 font-mono"><span id="current-time">0:00</span><span id="total-time">0:00</span></div>
            </div>
            <div id="audio-controls" class="flex items-center justify-center gap-8 mt-2 mb-6">
                <button id="prev-btn"><i class="fas fa-backward-step"></i></button>
                <button id="play-pause-btn" class="main-play-btn"><i class="fas fa-circle-play"></i></button>
                <button id="next-btn"><i class="fas fa-forward-step"></i></button>
            </div>
            <div class="file-input-container p-4 text-center w-full">
                <label for="file-upload" class="cursor-pointer flex flex-col items-center justify-center h-full hover:text-white transition-colors group">
                    <i class="fas fa-cloud-upload-alt text-2xl mb-2 text-green-500 group-hover:text-green-400"></i>
                    <span class="text-sm text-gray-300 font-medium group-hover:text-white">Importar Pasta</span>
                    <input type="file" id="file-upload" webkitdirectory="" mozdirectory="" class="hidden" multiple="">
                </label>
            </div>
        </section>

        <section class="card lg:col-span-2 flex flex-col h-[600px]">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 pb-2 border-b border-white/10 gap-4">
                <h2 class="text-xl font-bold text-white whitespace-nowrap">Biblioteca</h2>
                <input type="text" id="search-input" placeholder="Pesquisar pastas ou músicas..." class="search-input text-sm">
            </div>
            <div id="library-container" class="flex-1 overflow-y-auto pr-2 custom-scrollbar relative"></div>
        </section>
    </main>

    <div id="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-4">Título</h3>
            <p id="modal-message" class="text-gray-300 mb-6">Mensagem</p>
            <div id="modal-input-container" class="mb-6 hidden"><input type="text" id="modal-input" class="modal-input" placeholder="Digite aqui..."></div>
            <div class="flex justify-center gap-4">
                <button id="btn-cancel" class="modal-btn btn-cancel">Cancelar</button>
                <button id="btn-confirm" class="modal-btn btn-confirm-green">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="modal-box">
            <div class="spinner"></div>
            <h3 class="text-xl font-bold text-white">Importando...</h3>
            <p class="text-gray-400 text-sm mt-2">Organizando sua biblioteca musical</p>
        </div>
    </div>

    <footer class="text-center mt-12 text-gray-500 text-xs w-full relative z-10 pb-6 uppercase tracking-widest">
        <p>&copy; 2025 VinilPlay Experience</p>
    </footer>

    <audio id="audio-player" class="hidden"></audio>
</body>
</html>