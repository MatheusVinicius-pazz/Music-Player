<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reprodutor de Música - VinilPlay</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.8)), url('https://res.cloudinary.com/dnrrgpoxt/image/upload/v1763463280/Gemini_Generated_Image_hutje5hutje5hutj_fwwtih.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            color: #e0e0e0;
        }
        .container { max-width: 1200px; }
        .card {
            background-color: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }
        
        /* --- ESTILOS ESPECÍFICOS DO DRIVE --- */
        .folder-grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            border: 1px solid transparent;
        }
        .folder-grid-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .folder-icon-large {
            width: 70px;
            height: 70px;
            object-fit: contain;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }
        
        .song-list-item {
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 0.8rem 1rem;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .song-list-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .song-list-item.active {
            background-color: rgba(29, 185, 84, 0.2);
            border-left: 4px solid #1db954;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #a0a0a0;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .breadcrumb button { color: #1db954; font-weight: bold; }
        .breadcrumb button:hover { text-decoration: underline; }

        /* Botões de Login */
        .btn-google {
            background-color: white;
            color: #333;
            font-weight: bold;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s;
        }
        .btn-google:hover { transform: scale(1.02); }
        
        /* Modais e Loaders */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(5px); z-index: 200;
            display: none; align-items: center; justify-content: center;
            flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top-color: #1db954; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Player */
        #audio-controls button.main-play-btn {
            font-size: 3.5rem; color: #1db954;
            filter: drop-shadow(0 0 10px rgba(29, 185, 84, 0.5));
        }
        #progress-bar-container {
            height: 6px; background: rgba(255,255,255,0.1);
            border-radius: 3px; cursor: pointer; overflow: hidden;
        }
        #progress-bar {
            height: 100%; background: #1db954; width: 0%;
        }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center min-h-screen">

    <script>
        // --- CONFIGURAÇÕES DO GOOGLE ---
        // Substitua com suas chaves reais
        const API_KEY = 'AIzaSyCKKdpQ6bOs4xLlPOnOl6d3yrifcdS4g3k'; 
        const CLIENT_ID = '930970813412-po7j1nnkp3rjbbqfekcc65kgg4mrcmq9.apps.googleusercontent.com';
        
        // Escopos: Ler e Escrever arquivos no Drive
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;

        // Estado da Aplicação
        let currentFolderId = 'root'; // Começa na raiz do Drive
        let folderStack = [{id: 'root', name: 'Meu Drive'}]; // Histórico de navegação
        let driveItems = []; // Itens da pasta atual
        let currentSongIndex = -1;
        let isPlaying = false;
        
        // Ícone personalizado
        const folderIconUrl = "https://res.cloudinary.com/dnrrgpoxt/image/upload/v1763466883/Gemini_Generated_Image_tvtbx4tvtbx4tvtb-removebg-preview_vzpqjy.png";

        document.addEventListener('DOMContentLoaded', () => {
            // Elementos UI
            const btnLogin = document.getElementById('btn-login');
            const btnLogout = document.getElementById('btn-logout');
            const loginSection = document.getElementById('login-section');
            const mainContent = document.getElementById('main-content');
            const libraryContainer = document.getElementById('library-container');
            const audioPlayer = document.getElementById('audio-player');
            const playBtn = document.getElementById('play-pause-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const currentSongTitle = document.getElementById('current-song-title');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const totalTimeEl = document.getElementById('total-time');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const uploadInput = document.getElementById('upload-input');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');

            // --- INICIALIZAÇÃO DO GOOGLE API ---
            function gapiLoaded() {
                gapi.load('client', initializeGapiClient);
            }

            async function initializeGapiClient() {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                maybeEnableButtons();
            }

            function gisLoaded() {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // Definido no momento do clique
                });
                gisInited = true;
                maybeEnableButtons();
            }

            function maybeEnableButtons() {
                if (gapiInited && gisInited) {
                    btnLogin.disabled = false;
                    btnLogin.classList.remove('opacity-50', 'cursor-not-allowed');
                    btnLogin.innerHTML = '<i class="fab fa-google text-xl"></i> Conectar ao Google Drive';
                }
            }
            
            // Exportar funções globais para as bibliotecas do Google chamarem
            window.gapiLoaded = gapiLoaded;
            window.gisLoaded = gisLoaded;

            // --- AUTENTICAÇÃO ---
            btnLogin.addEventListener('click', () => {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    accessToken = resp.access_token;
                    showMainInterface();
                    await listFiles();
                };

                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            });

            btnLogout.addEventListener('click', () => {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                    accessToken = null;
                    showLoginInterface();
                }
            });

            function showMainInterface() {
                loginSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                mainContent.classList.add('grid');
            }

            function showLoginInterface() {
                loginSection.classList.remove('hidden');
                mainContent.classList.add('hidden');
                mainContent.classList.remove('grid');
                audioPlayer.pause();
            }

            // --- LÓGICA DO DRIVE ---
            
            // Lista arquivos da pasta atual
            async function listFiles() {
                showLoading("Carregando biblioteca...");
                try {
                    // Query: Não lixo, dentro da pasta atual, e (é pasta OU é áudio)
                    const query = `'${currentFolderId}' in parents and trashed = false and (mimeType = 'application/vnd.google-apps.folder' or mimeType contains 'audio/')`;
                    
                    const response = await gapi.client.drive.files.list({
                        'pageSize': 100,
                        'fields': "nextPageToken, files(id, name, mimeType, webContentLink, webViewLink)",
                        'q': query,
                        'orderBy': 'folder, name'
                    });
                    
                    driveItems = response.result.files;
                    renderLibrary();
                } catch (err) {
                    console.error("Erro ao listar arquivos", err);
                    alert("Erro ao acessar o Drive. Verifique o console.");
                } finally {
                    hideLoading();
                }
            }

            // Renderiza a interface
            function renderLibrary() {
                libraryContainer.innerHTML = '';

                // Breadcrumb
                const breadcrumbDiv = document.createElement('div');
                breadcrumbDiv.className = 'breadcrumb';
                
                // Renderiza caminho
                folderStack.forEach((folder, index) => {
                    if (index > 0) {
                        const sep = document.createElement('span');
                        sep.innerHTML = '<i class="fas fa-chevron-right text-xs mx-2"></i>';
                        breadcrumbDiv.appendChild(sep);
                    }
                    
                    const btn = document.createElement('button');
                    btn.textContent = folder.name;
                    btn.onclick = () => navigateToFolderIndex(index);
                    // Se for o último (pasta atual), deixa texto normal
                    if (index === folderStack.length - 1) {
                        btn.classList.remove('text-green-400');
                        btn.classList.add('text-white', 'cursor-default');
                        btn.onclick = null;
                    }
                    breadcrumbDiv.appendChild(btn);
                });
                libraryContainer.appendChild(breadcrumbDiv);

                if (!driveItems || driveItems.length === 0) {
                    libraryContainer.innerHTML += `<div class="text-center text-gray-500 mt-10">Esta pasta está vazia.</div>`;
                    return;
                }

                // Container para Grid de Pastas
                const folders = driveItems.filter(f => f.mimeType === 'application/vnd.google-apps.folder');
                if (folders.length > 0) {
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-2 mb-4';
                    
                    folders.forEach(folder => {
                        const el = document.createElement('div');
                        el.className = 'folder-grid-item group';
                        el.innerHTML = `
                            <img src="${folderIconUrl}" class="folder-icon-large group-hover:scale-110 transition-transform">
                            <span class="text-white text-sm font-semibold truncate w-full">${folder.name}</span>
                        `;
                        el.onclick = () => navigateToFolder(folder.id, folder.name);
                        grid.appendChild(el);
                    });
                    libraryContainer.appendChild(grid);
                }

                // Lista de Músicas
                const songs = driveItems.filter(f => f.mimeType.includes('audio/'));
                if (songs.length > 0) {
                    const list = document.createElement('ul');
                    list.className = 'space-y-1';
                    
                    songs.forEach((song, index) => {
                        // Precisamos mapear o índice relativo à lista de músicas apenas
                        const el = document.createElement('li');
                        el.className = 'song-list-item';
                        // Verifica se esta música específica está tocando
                        if (currentSongTitle.textContent === song.name) el.classList.add('active');

                        el.innerHTML = `
                            <div class="flex items-center gap-3 overflow-hidden">
                                <i class="fas fa-music text-gray-500 text-xs"></i>
                                <span class="text-gray-200 text-sm font-medium truncate">${song.name}</span>
                            </div>
                            <i class="fas fa-play text-xs text-gray-500 hover:text-green-400"></i>
                        `;
                        el.onclick = () => playDriveFile(song);
                        list.appendChild(el);
                    });
                    libraryContainer.appendChild(list);
                }
            }

            // Navegação
            async function navigateToFolder(folderId, folderName) {
                currentFolderId = folderId;
                folderStack.push({id: folderId, name: folderName});
                await listFiles();
            }

            async function navigateToFolderIndex(index) {
                // Corta o histórico até o índice clicado
                folderStack = folderStack.slice(0, index + 1);
                currentFolderId = folderStack[index].id;
                await listFiles();
            }

            // --- REPRODUÇÃO (STREAMING) ---
            async function playDriveFile(file) {
                showLoading("Preparando áudio...");
                try {
                    currentSongTitle.textContent = file.name;
                    
                    // Truque para Streaming Seguro: Fetch com Auth Header
                    const response = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    });
                    
                    if (!response.ok) throw new Error('Falha no download');

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    
                    audioPlayer.src = url;
                    audioPlayer.play();
                    isPlaying = true;
                    updatePlayButtonUI();
                    renderLibrary(); // Atualiza destaque visual

                } catch (err) {
                    console.error("Erro ao tocar", err);
                    alert("Erro ao carregar o áudio do Drive.");
                } finally {
                    hideLoading();
                }
            }

            // --- UPLOAD PARA O DRIVE ---
            uploadInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                showLoading("Enviando para o Drive...");
                
                try {
                    // Metadados do arquivo (nome e pasta pai)
                    const metadata = {
                        'name': file.name,
                        'parents': [currentFolderId]
                    };

                    // Formulário Multipart (Metadata + Arquivo)
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', file);

                    // Upload via Fetch API
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                        body: form
                    });
                    
                    if (response.ok) {
                        await listFiles(); // Recarrega a lista
                        alert("Upload concluído!");
                    } else {
                        throw new Error("Erro no upload");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Falha ao enviar arquivo.");
                } finally {
                    hideLoading();
                    uploadInput.value = '';
                }
            });

            // --- UI HELPERS ---
            function showLoading(msg) {
                loadingText.textContent = msg || "Carregando...";
                loadingOverlay.classList.add('show');
                loadingOverlay.style.display = 'flex';
            }
            function hideLoading() {
                loadingOverlay.classList.remove('show');
                setTimeout(() => loadingOverlay.style.display = 'none', 300);
            }

            function updatePlayButtonUI() {
                playBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-circle-play"></i>';
            }

            // --- CONTROLES DO PLAYER ---
            playBtn.onclick = () => {
                if (audioPlayer.src) {
                    if (audioPlayer.paused) { audioPlayer.play(); isPlaying = true; }
                    else { audioPlayer.pause(); isPlaying = false; }
                    updatePlayButtonUI();
                }
            };

            audioPlayer.onended = () => { isPlaying = false; updatePlayButtonUI(); };
            
            audioPlayer.ontimeupdate = () => {
                if (!isNaN(audioPlayer.duration)) {
                    const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    progressBar.style.width = `${pct}%`;
                    currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                }
            };
            
            audioPlayer.onloadedmetadata = () => {
                totalTimeEl.textContent = formatTime(audioPlayer.duration);
            };

            progressBarContainer.onclick = (e) => {
                if (!isNaN(audioPlayer.duration)) {
                    const rect = progressBarContainer.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    audioPlayer.currentTime = pos * audioPlayer.duration;
                }
            };

            function formatTime(s) {
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60).toString().padStart(2, '0');
                return `${m}:${sec}`;
            }

        });
    </script>

    <header class="text-center mb-8 w-full relative z-10">
        <img src="https://res.cloudinary.com/dnrrgpoxt/image/upload/v1763465227/Gemini_Generated_Image_vx3v7rvx3v7rvx3v__1_-removebg-preview_xkkobr.png" alt="Logo VinilPlay" class="h-48 md:h-64 mx-auto mb-4 drop-shadow-2xl hover:scale-105 transition-transform duration-300" />
        <p class="text-gray-200 mt-2 drop-shadow-md font-medium text-xl tracking-wide">Sua coleção, na nuvem.</p>
    </header>

    <section id="login-section" class="w-full container max-w-md relative z-10">
        <div class="card flex flex-col items-center text-center">
            <h2 class="text-2xl font-bold text-white mb-4">Bem-vindo ao VinilPlay</h2>
            <p class="text-gray-400 mb-8">Conecte-se ao seu Google Drive para acessar suas músicas de qualquer lugar.</p>
            
            <button id="btn-login" disabled class="btn-google opacity-50 cursor-not-allowed">
                <i class="fas fa-spinner fa-spin"></i> Carregando API...
            </button>
            
            <p class="text-xs text-gray-500 mt-4">Seus dados são acessados diretamente pelo navegador. Nada é salvo em nossos servidores.</p>
        </div>
    </section>

    <main id="main-content" class="hidden w-full container grid-cols-1 lg:grid-cols-3 gap-8 relative z-10">
        <section class="card lg:col-span-1 flex flex-col items-center h-fit sticky top-4">
            <div class="w-full flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white">Player</h2>
                <button id="btn-logout" class="text-xs text-red-400 hover:text-red-300">Sair</button>
            </div>
            
            <div class="w-full aspect-square rounded-xl bg-black/40 border border-white/10 mb-6 flex items-center justify-center shadow-inner relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-tr from-green-900/20 to-transparent"></div>
                <i class="fas fa-music text-7xl text-green-500/30 group-hover:scale-110 transition-transform duration-500"></i>
            </div>
            
            <div class="w-full mb-6">
                <p id="current-song-title" class="text-lg font-bold text-white truncate w-full text-center mb-1">Nenhuma música selecionada</p>
                <p class="text-xs text-green-400 text-center font-mono">STREAMING DRIVE</p>
            </div>
            
            <div class="w-full my-2">
                <div id="progress-bar-container" class="mb-2"><div id="progress-bar"></div></div>
                <div class="flex justify-between text-xs text-gray-400 font-mono"><span id="current-time">0:00</span><span id="total-time">0:00</span></div>
            </div>

            <div id="audio-controls" class="flex items-center justify-center gap-8 mt-2 mb-6">
                <button id="prev-btn"><i class="fas fa-backward-step"></i></button>
                <button id="play-pause-btn" class="main-play-btn"><i class="fas fa-circle-play"></i></button>
                <button id="next-btn"><i class="fas fa-forward-step"></i></button>
            </div>

            <div class="file-input-container p-4 text-center w-full">
                <label for="upload-input" class="cursor-pointer flex flex-col items-center justify-center h-full hover:text-white transition-colors group">
                    <i class="fas fa-cloud-upload-alt text-2xl mb-2 text-green-500 group-hover:text-green-400"></i>
                    <span class="text-sm text-gray-300 font-medium group-hover:text-white">Enviar Música para esta Pasta</span>
                    <input type="file" id="upload-input" class="hidden" accept="audio/*">
                </label>
            </div>
        </section>

        <section class="card lg:col-span-2 flex flex-col h-[600px]">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-white/10">
                <h2 class="text-xl font-bold text-white">Meu Drive</h2>
                <span class="text-xs text-gray-400 uppercase tracking-widest">MP3 • FLAC</span>
            </div>
            <div id="library-container" class="flex-1 overflow-y-auto pr-2 custom-scrollbar relative">
                </div>
        </section>
    </main>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3 id="loading-text" class="text-xl font-bold text-white">Carregando...</h3>
    </div>

    <footer class="text-center mt-12 text-gray-500 text-xs w-full relative z-10 pb-6 uppercase tracking-widest">
        <p>&copy; 2025 VinilPlay Experience</p>
    </footer>

    <audio id="audio-player" class="hidden"></audio>
</body>
</html>